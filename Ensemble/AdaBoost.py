#!/usr/bin/env python
# coding: utf-8

# In[13]:


import numpy as np

def create_data():
    '''
    X: ä¸€ä¸ª5è¡Œ2åˆ—çš„NumPyæ•°ç»„ï¼Œè¡¨ç¤º5ä¸ªæ ·æœ¬çš„ç‰¹å¾ã€‚æ¯è¡Œä»£è¡¨ä¸€ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬æœ‰ä¸¤ä¸ªç‰¹å¾ã€‚
    y: ä¸€ä¸ªåŒ…å«5ä¸ªå…ƒç´ çš„NumPyæ•°ç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªæ ·æœ¬çš„ç±»æ ‡ç­¾ã€‚è¿™é‡Œæœ‰3ä¸ªæ­£ç±»ï¼ˆ1ï¼‰å’Œ2ä¸ªè´Ÿç±»ï¼ˆ-1ï¼‰ã€‚
    '''
    # åˆ›å»ºä¸€ä¸ªç®€å•çš„äºŒåˆ†ç±»æ•°æ®é›†
    X = np.array([[1, 2], [2, 3], [3, 3], [2, 1], [3, 2]])
    y = np.array([1, 1, 1, -1, -1])
    return X, y
'''
X: è¾“å…¥çš„æ•°æ®é›†ã€‚
dimension: ç”¨äºåˆ†ç±»æ¯”è¾ƒçš„ç‰¹å¾ç»´åº¦ï¼ˆåˆ—ç´¢å¼•ï¼‰ã€‚
thresh_val: åˆ†ç±»çš„é˜ˆå€¼ã€‚
thresh_ineq: é˜ˆå€¼ä¸ç­‰å¼çš„æ–¹å‘ã€‚å¯ä»¥æ˜¯ "lt" ï¼ˆå°äºç­‰äºæ—¶ä¸ºè´Ÿç±»ï¼‰æˆ– "gt" ï¼ˆå¤§äºæ—¶ä¸ºè´Ÿç±»ï¼‰ã€‚


ret_array: åˆå§‹åŒ–ä¸ºå…¨1çš„æ•°ç»„ï¼Œå¤§å°ä¸æ ·æœ¬æ•°é‡ç›¸åŒã€‚è¿™è¡¨ç¤ºå¼€å§‹æ—¶æ‰€æœ‰æ ·æœ¬éƒ½å‡è®¾ä¸ºæ­£ç±»ã€‚

å¦‚æœ thresh_ineq æ˜¯ "lt"ï¼Œåˆ™å½“ X ä¸­çš„ç‰¹å®šç»´åº¦çš„å€¼å°äºæˆ–ç­‰äº thresh_val æ—¶ï¼Œ
å°†å¯¹åº”çš„ ret_array ä¸­çš„å€¼è®¾ç½®ä¸º -1.0ï¼Œè¡¨ç¤ºè¿™äº›æ ·æœ¬ä¸ºè´Ÿç±»ã€‚

å¦‚æœ thresh_ineq æ˜¯ "gt"ï¼Œåˆ™å½“ X ä¸­çš„ç‰¹å®šç»´åº¦çš„å€¼å¤§äº thresh_val æ—¶ï¼Œè¿›è¡ŒåŒæ ·çš„æ“ä½œã€‚
'''
def stump_classify(X, dimension, thresh_val, thresh_ineq):
    # é€šè¿‡é˜ˆå€¼æ¯”è¾ƒå¯¹æ•°æ®è¿›è¡Œåˆ†ç±»
    ret_array = np.ones((np.shape(X)[0], 1))
    if thresh_ineq == 'lt':
        ret_array[X[:, dimension] <= thresh_val] = -1.0
    else:
        ret_array[X[:, dimension] > thresh_val] = -1.0
    return ret_array#å³è¿”å›æ¯ä¸ªæ ·æœ¬åŸºäºé˜ˆå€¼æ¡ä»¶è¢«åˆ†ç±»çš„ç»“æœã€‚


# In[14]:


'''
X: è®­ç»ƒæ•°æ®çš„ç‰¹å¾çŸ©é˜µã€‚
y: è®­ç»ƒæ•°æ®çš„æ ‡ç­¾å‘é‡ã€‚
D: æ¯ä¸ªè®­ç»ƒæ ·æœ¬çš„æƒé‡ã€‚
'''
def build_stump(X, y, D):
    m, n = np.shape(X)#æ•°æ®é›†çš„æ ·æœ¬æ•°å’Œç‰¹å¾æ•°ã€‚
    num_steps = 10.0 #æ¯ä¸ªç‰¹å¾çš„é˜ˆå€¼å°†åœ¨å…¶æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹é—´åˆ†æˆå¤šå°‘æ­¥éª¤æ¥è€ƒå¯Ÿã€‚
    best_stump = {}#ç”¨æ¥å­˜å‚¨æœ€ä½³å†³ç­–æ ‘æ¡©çš„ä¿¡æ¯ã€‚
    best_class_est = np.zeros((m, 1))#å­˜å‚¨å½“å‰æœ€ä½³å†³ç­–æ ‘æ¡©çš„åˆ†ç±»ç»“æœã€‚
    min_error = np.inf# åˆå§‹å€¼å‡è®¾æœ€å°é”™è¯¯ç‡ä¸ºæ— ç©·å¤§ï¼Œç”¨äºè®°å½•æœ€å°çš„åŠ æƒé”™è¯¯ç‡ã€‚

    for i in range(n):
        #range_min, range_max: å½“å‰ç‰¹å¾çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚
        range_min = X[:, i].min()
        range_max = X[:, i].max()
        #æ ¹æ®num_stepsè®¡ç®—å‡ºçš„æ­¥é•¿ã€‚
        step_size = (range_max - range_min) / num_steps
        #j: ä»-1å¼€å§‹ï¼Œåˆ°num_steps + 1ç»“æŸï¼Œå…è®¸åœ¨æœ€å°å€¼å’Œæœ€å¤§å€¼ä¹‹å¤–ä¸€ç‚¹çš„æ¢ç´¢ï¼Œä»¥ç¡®ä¿è¦†ç›–æ‰€æœ‰å¯èƒ½çš„é˜ˆå€¼ã€‚
        for j in range(-1, int(num_steps) + 1):
            for inequal in ['lt', 'gt']:#éå†'lt'ï¼ˆå°äºï¼‰å’Œ'gt'ï¼ˆå¤§äºï¼‰ï¼Œä»£è¡¨ä¸åŒçš„ä¸ç­‰å¼ã€‚
                thresh_val = (range_min + float(j) * step_size)# è®¡ç®—å‡ºçš„å½“å‰é˜ˆå€¼ã€‚
                '''
                æŠŠæ•°æ®é›†ã€ç‰¹å¾ç»´åº¦ã€é˜ˆå€¼ã€ä»£å…¥'lt'ï¼ˆå°äºï¼‰å’Œ'gt'ï¼ˆå¤§äºï¼‰ï¼Œä¸åŒçš„ä¸ç­‰å¼ã€‚
                '''
                predicted_vals = stump_classify(X, i, thresh_val, inequal)
                err_arr = np.ones((m, 1))#é”™è¯¯æ•°ç»„ï¼Œåˆå§‹åŒ–ä¸º1ï¼ˆå‡è®¾æ‰€æœ‰åˆ†ç±»éƒ½æ˜¯é”™è¯¯çš„ï¼‰ã€‚
                err_arr[predicted_vals == y.reshape(-1, 1)] = 0#æ›´æ–°é”™è¯¯æ•°ç»„ä¸­æ­£ç¡®åˆ†ç±»çš„ä½ç½®ä¸º0ã€‚
                weighted_error = D.T.dot(err_arr)#è®¡ç®—åŠ æƒé”™è¯¯ï¼Œé€šè¿‡ç‚¹ç§¯å°†é”™è¯¯æ•°ç»„ä¸æ ·æœ¬æƒé‡Dç›¸ä¹˜ã€‚
                '''
                å¦‚æœå½“å‰å†³ç­–æ ‘æ¡©çš„åŠ æƒé”™è¯¯ç‡ä½äºä¹‹å‰çš„æœ€ä½³è®°å½•ï¼Œåˆ™æ›´æ–°æœ€ä½³å†³ç­–æ ‘æ¡©ä¿¡æ¯ã€‚
                '''
                if weighted_error < min_error:
                    min_error = weighted_error
                    best_class_est = predicted_vals.copy()
                    best_stump['dim'] = i
                    best_stump['thresh'] = thresh_val
                    best_stump['ineq'] = inequal
    return best_stump, min_error, best_class_est#è¿”å›åŒ…å«æœ€ä½³å†³ç­–æ ‘æ¡©çš„å­—å…¸ã€æœ€å°é”™è¯¯ç‡å’Œæœ€ä½³åˆ†ç±»ä¼°è®¡ã€‚


# In[15]:


'''
å®ç°AdaBoostç®—æ³•çš„æ ¸å¿ƒè®­ç»ƒè¿‡ç¨‹ï¼Œä¸»è¦ç”¨äºè®­ç»ƒä¸€ä¸ªç”±å¤šä¸ªå¼±åˆ†ç±»å™¨ï¼ˆå†³ç­–æ ‘æ¡©ï¼‰ç»„æˆçš„å¼ºåˆ†ç±»å™¨ã€‚
æ•°æ® Xï¼ˆç‰¹å¾ï¼‰ï¼Œæ ‡ç­¾ yï¼Œä»¥åŠç®—æ³•è¿­ä»£çš„æ¬¡æ•° num_itersï¼ˆé»˜è®¤ä¸º40æ¬¡ï¼‰ã€‚
è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒæ˜¯é€šè¿‡é€æ­¥æå‡é”™è¯¯åˆ†ç±»æ ·æœ¬çš„æƒé‡ï¼Œé€æ¸å¢å¼ºåˆ†ç±»æ¨¡å‹çš„é²æ£’æ€§ï¼Œæœ€ç»ˆè·å¾—è¾ƒé«˜çš„åˆ†ç±»ç²¾åº¦ã€‚
'''
def adaboost_train_ds(X, y, num_iters=40):
    weak_class_arr = []#åˆå§‹åŒ–ç”¨äºå­˜å‚¨æ¯ä¸€è½®è¿­ä»£ä¸­å¾—åˆ°çš„æœ€ä½³å¼±åˆ†ç±»å™¨åŠå…¶ç›¸å…³ä¿¡æ¯ã€‚
    '''
    m æ˜¯æ•°æ®é›†ä¸­æ ·æœ¬çš„æ•°é‡ã€‚
    åˆå§‹åŒ–æ ·æœ¬æƒé‡ Dï¼Œä¸€å¼€å§‹æ¯ä¸ªæ ·æœ¬çš„æƒé‡éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œå³æ¯ä¸ªæ ·æœ¬çš„åˆå§‹æƒé‡ä¸º 1/mã€‚
    åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„ agg_class_estï¼Œç”¨äºç´¯åŠ æ¯ä¸ªå¼±åˆ†ç±»å™¨çš„åŠ æƒé¢„æµ‹ç»“æœï¼Œè¿™å°†ç”¨äºè®¡ç®—æ•´ä¸ªæ¨¡å‹çš„æœ€ç»ˆé¢„æµ‹ã€‚
    '''
    m = np.shape(X)[0]
    D = np.ones((m, 1)) / m
    agg_class_est = np.zeros((m, 1))

    for i in range(num_iters):
        '''
        è°ƒç”¨ build_stump å‡½æ•°å¯»æ‰¾å½“å‰æƒé‡ D ä¸‹çš„æœ€ä½³å¼±åˆ†ç±»å™¨ best_stumpï¼Œ
        è¯¥å‡½æ•°è¿˜è¿”å›è¯¥åˆ†ç±»å™¨çš„é”™è¯¯ç‡ error å’Œå¯¹è®­ç»ƒæ•°æ®çš„åˆ†ç±»ç»“æœ class_estã€‚
        '''
        best_stump, error, class_est = build_stump(X, y, D)
        '''
        æ ¹æ®é”™è¯¯ç‡è®¡ç®—è¯¥å¼±åˆ†ç±»å™¨çš„æƒé‡ alphaï¼Œä½¿ç”¨ä¸€ä¸ªå¾ˆå°çš„å¸¸æ•° 1e-16 é˜²æ­¢é™¤é›¶é”™è¯¯ã€‚
        æƒé‡ alpha åæ˜ äº†è¿™ä¸ªå¼±åˆ†ç±»å™¨åœ¨æœ€ç»ˆå†³ç­–ä¸­çš„é‡è¦æ€§ï¼Œé”™è¯¯ç‡è¶Šä½ï¼Œæƒé‡è¶Šå¤§ã€‚
        alpha çš„å…¬å¼å°±æ˜¯
        Î±= 1/2  â€‹ log(1âˆ’Ïµ/ Ïµ)
        è¯¥å…¬å¼ç¡®ä¿äº†å½“é”™è¯¯ç‡ ğœ–æ¥è¿‘ 0 æ—¶ï¼ˆå³å­¦ä¹ å™¨è¡¨ç°å¾ˆå¥½æ—¶ï¼‰ï¼Œè¯¥å­¦ä¹ å™¨çš„æƒé‡ğ›¼è¶‹å‘äºæ— é™å¤§ï¼Œå¯¹æœ€ç»ˆçš„æ¨¡å‹é¢„æµ‹å½±å“è¾ƒå¤§ã€‚
        å½“ ğœ– æ¥è¿‘ 0.5 æ—¶ï¼ˆå³å­¦ä¹ å™¨è¡¨ç°ä»…ç•¥å¥½äºéšæœºçŒœæµ‹æ—¶ï¼‰ï¼Œ ğ›¼è¶‹å‘äº 0ï¼Œæ„å‘³ç€è¯¥å­¦ä¹ å™¨çš„å½±å“å¾ˆå°ã€‚
        å½“ ğœ– å¤§äº 0.5 æ—¶ï¼ˆå³å­¦ä¹ å™¨è¡¨ç°è¿˜ä¸å¦‚éšæœºçŒœæµ‹æ—¶ï¼‰ï¼Œğ›¼å¯èƒ½æ˜¯è´Ÿå€¼ï¼Œè¡¨ç¤ºéœ€è¦åå‘è°ƒæ•´å…¶å¯¹æœ€ç»ˆé¢„æµ‹çš„è´¡çŒ®ã€‚
        '''
        alpha = 0.5 * np.log((1.0 - error) / max(error, 1e-16))
        '''
        å°†è®¡ç®—å¾—åˆ°çš„ alpha å€¼å­˜å‚¨åˆ° best_stump å­—å…¸ä¸­ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° weak_class_arr åˆ—è¡¨ä¸­ã€‚
        '''
        best_stump['alpha'] = alpha
        weak_class_arr.append(best_stump)
        '''
        è¿™ä¸ªå…¬å¼æ˜¯ç”¨äºè®¡ç®—æ–°çš„æ ·æœ¬æƒé‡çš„å…³é”®éƒ¨åˆ†ã€‚
        è®¡ç®—çš„æ˜¯çœŸå®æ ‡ç­¾ä¸åˆ†ç±»ç»“æœçš„ä¹˜ç§¯ã€‚å¦‚æœåˆ†ç±»ç»“æœæ­£ç¡®ï¼ˆå³é¢„æµ‹å€¼å’ŒçœŸå®å€¼ç›¸åŒï¼‰ï¼Œ
        é‚£ä¹ˆç»“æœå°†ä¸º+1ï¼ˆå› ä¸º 1Ã—1=1    å’Œ (âˆ’1)Ã—(âˆ’1)=1ï¼›
        å¦‚æœåˆ†ç±»ç»“æœé”™è¯¯ï¼ˆå³é¢„æµ‹å€¼å’ŒçœŸå®å€¼ç›¸åï¼‰ï¼Œ
        é‚£ä¹ˆç»“æœå°†ä¸º-1ï¼ˆå› ä¸º1Ã—(âˆ’1)=âˆ’1å’Œ (âˆ’1)Ã—1=âˆ’1ã€‚
        å¦‚æœä¸€ä¸ªæ ·æœ¬è¢«é”™è¯¯åˆ†ç±»ï¼ˆy * class_est ä¸º-1ï¼‰ï¼Œé‚£ä¹ˆ exp(-alpha * -1) å°†å¢åŠ è¿™ä¸ªæ ·æœ¬çš„æƒé‡ï¼Œå› ä¸º exp(alpha) æ€»æ˜¯å¤§äº1ã€‚
        å¦‚æœä¸€ä¸ªæ ·æœ¬è¢«æ­£ç¡®åˆ†ç±»ï¼ˆy * class_est ä¸º+1ï¼‰ï¼Œé‚£ä¹ˆ exp(-alpha * 1) å°†å‡å°‘è¿™ä¸ªæ ·æœ¬çš„æƒé‡ï¼Œå› ä¸º exp(-alpha) æ€»æ˜¯å°äº1ï¼ˆä½†å¤§äº0ï¼‰ã€‚
        
        è¿™ä¸ªè®¡ç®—å¾—åˆ°çš„ expon æ•°å€¼è¢«ç”¨äºæ›´æ–°æ¯ä¸ªæ ·æœ¬çš„æƒé‡ ğ·ã€‚
        D = D * np.exp(expon): æ ¹æ® expon çš„å€¼ï¼Œç›¸åº”åœ°è°ƒæ•´æ¯ä¸ªæ ·æœ¬çš„æƒé‡ã€‚
        è¿™ç¡®ä¿äº†åœ¨ä¸‹ä¸€è½®ä¸­ï¼Œè¢«å½“å‰åˆ†ç±»å™¨é”™è¯¯åˆ†ç±»çš„æ ·æœ¬å°†è·å¾—æ›´é«˜çš„å…³æ³¨ï¼ˆæƒé‡æ›´å¤§ï¼‰ï¼Œ
        è€Œè¢«æ­£ç¡®åˆ†ç±»çš„æ ·æœ¬çš„æƒé‡åˆ™å‡å°‘ã€‚ä¹Ÿå°±æ˜¯è¯´é”™çš„æƒé‡è¶Šå¤§ã€å¯¹çš„æƒé‡è¶Šå°ã€‚
        '''
        expon = -alpha * y.reshape(-1, 1) * class_est
        D = D * np.exp(expon)
        D = D / D.sum()
        #æ›´æ–°ç´¯è®¡çš„ç±»åˆ«ä¼°è®¡ agg_class_estï¼Œå¹¶è®¡ç®—å½“å‰æ¨¡å‹çš„é”™è¯¯ç‡ error_rateã€‚
        agg_class_est += alpha * class_est
        agg_errors = np.sign(agg_class_est) != y.reshape(-1, 1)
        error_rate = agg_errors.mean()
        #å¦‚æœé”™è¯¯ç‡è¾¾åˆ°0ï¼Œå³æ‰€æœ‰æ ·æœ¬éƒ½è¢«æ­£ç¡®åˆ†ç±»ï¼Œåˆ™æå‰ç»“æŸè¿­ä»£ã€‚
        if error_rate == 0.0:
            break

    return weak_class_arr, agg_class_est


# In[16]:


X, y = create_data()
weak_class_arr, agg_class_est = adaboost_train_ds(X, y, num_iters=10)
print("Classifiers:", weak_class_arr)


# In[ ]:




